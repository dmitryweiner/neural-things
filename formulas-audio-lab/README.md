# Formula Audio Lab

**Веб-приложение для синтеза звука на основе математических формул.**

Интерактивная аудио-лаборатория, где звук генерируется в реальном времени через AudioWorklet API. Каждый генератор — это математическая формула, превращённая в звуковую волну.

---

## Архитектура

### Аудио-граф

```text
[Generators] → [MixBus] → [FX Input] → [Filter?] → [Chorus?] → [Reverb?] → [Limiter?] → [MasterGain] → [Analyser] → [Destination]
                                                                                              ↓
                                                                                      [MediaStreamDest] → Recording
```

- **AudioWorklet** (`FormulaGeneratorProcessor`) — генерация семплов в отдельном аудио-потоке
- **MixBus** — суммирование всех активных генераторов
- **Effects** — опциональная цепочка эффектов (каждый можно вкл/выкл)
- **Analyser** — данные для осциллоскопа

### Состояние UI

Всё состояние сериализуется в JSON:
- Сохранение в `localStorage` (кнопка "Сохранить пресет")
- Кодирование в URL hash через base64url (кнопка "Поделиться")
- Автозагрузка из URL при открытии страницы

---

## Генераторы (Formulas)

Каждый генератор можно включить независимо (checkbox), параметры регулируются слайдерами.

### 1. FM-синус (`fm`)
**Формула:** `sin(2π·fc·t + I·sin(2π·fm·t))`

Частотная модуляция. Несущая частота `fc` модулируется синусоидой `fm` с индексом модуляции `I`.

| Параметр | Описание | Диапазон |
|----------|----------|----------|
| `fc` | Несущая частота (Hz) | 20–2000 |
| `fm` | Частота модулятора (Hz) | 0.1–60 |
| `I` | Индекс модуляции | 0–20 |

---

### 2. AM / биения (`am`)
**Формула:** `sin(2π·f1·t) · sin(2π·f2·t)`

Амплитудная модуляция / умножение двух синусоид.

| Параметр | Описание | Диапазон |
|----------|----------|----------|
| `f1` | Первая частота (Hz) | 20–2000 |
| `f2` | Вторая частота (Hz) | 20–2000 |

---

### 3. Логистическое отображение (`logistic`)
**Формула:** `x_{n+1} = r·x_n·(1 - x_n)`

Хаотическая система. Значение `x` управляет частотой синусоиды.

| Параметр | Описание | Диапазон |
|----------|----------|----------|
| `base` | Базовая частота (Hz) | 20–800 |
| `depth` | Глубина модуляции (Hz) | 0–1200 |
| `r` | Параметр хаоса | 2.8–4.0 |
| `lfoHz` | Частота обновления x | 1–400 |

**Примечание:** При `r < 3` — стабильно, при `r ≈ 3.57` — период-удвоение, при `r > 3.57` — хаос.

---

### 4. Экспоненциальный глиссандо (`gliss`)
**Формула:** `f(t) = f0 · e^(k·t)`

Частота экспоненциально растёт или падает со временем.

| Параметр | Описание | Диапазон |
|----------|----------|----------|
| `f0` | Начальная частота (Hz) | 10–400 |
| `k` | Скорость изменения | -2.0–2.0 |

**Примечание:** Используй "Reset state" для перезапуска с начала.

---

### 5. Сумма гармоник (`additive`)
**Формула:** `Σ (1/k)·sin(move·t + k) · sin(2π·k·fund·t)`

Аддитивный синтез с движущимися амплитудами гармоник.

| Параметр | Описание | Диапазон |
|----------|----------|----------|
| `fund` | Фундаментальная частота (Hz) | 20–500 |
| `N` | Количество гармоник | 1–40 |
| `move` | Скорость движения амплитуд (Hz) | 0.01–5 |

---

### 6. Фазовая модуляция (`pm`)
**Формула:** `sin(2π·f·t + 5·sin(sin(2π·f2·t)))`

Фаза модулируется вложенными синусами.

| Параметр | Описание | Диапазон |
|----------|----------|----------|
| `f` | Несущая частота (Hz) | 20–2000 |
| `f2pm` | Частота модулятора (Hz) | 0.1–40 |

**Примечание:** Используй "Reset state" для сброса фазы.

---

### 7. Два синуса — биения (`beats`)
**Формула:** `0.5·(sin(2π·f·t) + sin(2π·(f + Δf)·t))`

Классические биения — интерференция двух близких частот.

| Параметр | Описание | Диапазон |
|----------|----------|----------|
| `fbeat` | Базовая частота (Hz) | 20–2000 |
| `df` | Разница частот Δf (Hz) | 0–20 |

**Примечание:** Частота биений = `Δf` Гц.

---

### 8. Нелинейная сатурация (`dist`)
**Формула:** `tanh(α · sin(2π·f·t))`

Мягкое ограничение через гиперболический тангенс — добавляет гармоники.

| Параметр | Описание | Диапазон |
|----------|----------|----------|
| `fd` | Частота (Hz) | 20–2000 |
| `alpha` | Степень искажения | 0–10 |

---

### 9. Квазислучайный LFO (`quasi`)
**Формула:** `f(t) = fq + Aq · sin(sin(sin(w·t)))`

Частота модулируется тройным вложением sin — даёт псевдослучайное поведение.

| Параметр | Описание | Диапазон |
|----------|----------|----------|
| `fq` | Базовая частота (Hz) | 20–500 |
| `Aq` | Глубина (Hz) | 0–1200 |
| `wq` | Скорость w | 0.05–6 |

**Примечание:** Используй "Reset state" для сброса фазы.

---

### 10. Аттрактор Лоренца (`lorenz`)
**Формула:** Система ОДУ Лоренца → freq/amp

```text
dx/dt = σ(y - x)
dy/dt = x(ρ - z) - y  
dz/dt = xy - βz
```

Координаты аттрактора мапятся на частоту и амплитуду.

| Параметр | Описание | Диапазон |
|----------|----------|----------|
| `sigma` | σ | 0–30 |
| `rho` | ρ | 0–60 |
| `beta` | β | 0.1–10 |
| `lBase` | Базовая частота (Hz) | 20–400 |
| `lFreqScale` | Масштаб частоты | 0–200 |
| `lAmp` | Масштаб амплитуды | 0–1 |

**Классические значения:** σ=10, ρ=28, β=8/3 ≈ 2.667

**Примечание:** Используй "Reset state" для сброса состояния аттрактора.

---

### 11. Karplus–Strong (`karplus`)
**Формула:** `noise → delay line → averaging → feedback`

Физическое моделирование струны.

| Параметр | Описание | Диапазон |
|----------|----------|----------|
| `ksFreq` | Частота ноты (Hz) | 40–880 |
| `ksDamp` | Затухание | 0.90–0.9999 |
| `ksBright` | Яркость (баланс фильтра) | 0–1 |

**Примечание:** "Reset state" — щипок струны заново.

---

### 12. Bitcrusher / Downsample (`bitcrush`)
**Формула:** `quantize(sin(phase), bits) + sample_hold(down)`

Lo-Fi эффект: уменьшение битности и частоты дискретизации.

| Параметр | Описание | Диапазон |
|----------|----------|----------|
| `bcFreq` | Входная частота (Hz) | 20–2000 |
| `bcBits` | Битность | 1–16 |
| `bcDown` | Даунсемплинг (делитель) | 1–64 |

---

### 13. Noise → Low-pass (`noiselp`)
**Формула:** `white_noise → 1-pole LP filter`

Отфильтрованный белый шум.

| Параметр | Описание | Диапазон |
|----------|----------|----------|
| `nCut` | Частота среза (Hz) | 20–18000 |

---

## Эффекты

Панель "Effects" открывается кнопкой в верхней панели. Каждый эффект включается чекбоксом "ON".

### Filter (Biquad)
Стандартный биквадратный фильтр Web Audio API.

| Параметр | Описание |
|----------|----------|
| Type | low-pass / high-pass / band-pass |
| Cutoff | Частота среза (20–18000 Hz) |
| Q | Добротность (0.1–30) |

### Chorus / Flanger
Модулированная задержка с обратной связью.

| Параметр | Описание |
|----------|----------|
| Mode | chorus (base 12ms) / flanger (base 2ms) |
| Rate | Частота LFO (0.01–8 Hz) |
| Depth | Глубина модуляции (0–20 ms) |
| Mix | Баланс dry/wet (0–1) |
| Feedback | Обратная связь (0–0.95) |

### Reverb (Convolver)
Свёрточная реверберация с процедурным импульсом.

| Параметр | Описание |
|----------|----------|
| Decay | Время затухания (0.1–8 s) |
| Mix | Баланс dry/wet (0–1) |

### Limiter
Динамический компрессор в режиме лимитера (ratio=20).

| Параметр | Описание |
|----------|----------|
| Threshold | Порог (dB) (-40–0) |
| Release | Время восстановления (0.02–1 s) |

---

## UI элементы

### Верхняя панель
- **Start Audio** — запуск AudioContext (требует user gesture)
- **Stop** — остановка и очистка
- **Record WAV** — запись в WebM/OGG через MediaRecorder
- **Сохранить пресет** — в localStorage
- **Загрузить пресет** — из localStorage
- **Поделиться** — копирует URL с состоянием в буфер обмена
- **Status** — текущий статус
- **Effects** — открыть/закрыть панель эффектов (кнопка подсвечивается когда панель открыта)

### Осциллоскоп
- Автомасштабирование по Y
- Занимает всю ширину экрана
- Сворачивается кнопкой "Scope"
- Автоматически скрывается при открытии панели эффектов
- На мобильных свёрнут по умолчанию

### Панель эффектов
- Открывается кнопкой "Effects"
- Имеет прокрутку при переполнении (max-height: 60vh)
- При открытии автоматически скрывает осциллоскоп

### Карточки формул
- **Выключить все** — отключает все формулы одновременно
- Чекбокс — вкл/выкл генератор
- "Свернуть/Развернуть" — скрыть слайдеры
- "Reset state" — сброс внутреннего состояния (только для: Gliss, PM, Quasi, Lorenz, Karplus-Strong)

---

## Технические детали

### AudioWorklet Processor

```javascript
class FormulaGeneratorProcessor extends AudioWorkletProcessor {
  // Генерация семплов в process()
  // Коммуникация через port.postMessage({type: 'set'|'reset', params})
}
```

### Состояние (State)

```javascript
{
  v: 2,                    // версия формата
  masterGain: 0.25,
  scopeCollapsed: false,
  fx: {
    panelOpen: false,
    filterOn: false, filterType: 'lowpass', filterFreq: 12000, filterQ: 0.7,
    chorusOn: false, chorusMode: 'chorus', chorusRate: 0.35, ...
    reverbOn: false, reverbDecay: 2.8, reverbMix: 0.25,
    limiterOn: false, limiterThr: -12, limiterRel: 0.15
  },
  formulas: {
    fm: { enabled: false, collapsed: false, params: { gain: 0.15, fc: 220, ... } },
    am: { ... },
    ...
  }
}
```

### URL Sharing
Состояние кодируется в base64url и добавляется в hash:

```text
https://.../#s=eyJ2IjoyLCJtYXN0ZXJHYWluIjowLjI1LC4uLn0
```

---

## Советы по использованию

1. **Всегда начинай с низкого Gain** — некоторые формулы могут давать громкий выход
2. **Используй Limiter** при экспериментах с хаосом (Lorenz, Logistic)
3. **Комбинируй генераторы** — включай несколько одновременно
4. **Reset state** — доступен для 5 формул: Gliss, PM, Quasi, Lorenz, Karplus-Strong
   - Для Karplus-Strong это "щипок" струны заново
   - Для Gliss — начало с f0
   - Для Lorenz — сброс состояния аттрактора
5. **Выключить все** — быстрый способ отключить все генераторы
6. **Запись** — используй Record для сохранения интересных звуков

---

## Зависимости

Нет внешних зависимостей. Чистый HTML + CSS + JavaScript.

- Web Audio API (AudioWorklet, BiquadFilter, Convolver, DynamicsCompressor)
- MediaRecorder API для записи
- Canvas 2D для осциллоскопа

