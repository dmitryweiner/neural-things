<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Illegal Uzumaki (harmonic sum)</title>
  <style>
    html, body { margin:0; height:100%; background:#000; overflow:hidden; }
    canvas { display:block; width:100vw; height:100vh; }
    .ui{
      position:fixed; left:12px; top:12px;
      color:#eee; font:14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px;
      padding:12px;
      min-width: 280px;
      backdrop-filter: blur(6px);
    }
    .row{ display:flex; align-items:center; gap:10px; margin:8px 0; }
    .row label{ width:70px; opacity:.9; }
    .row input[type="range"]{ flex:1; }
    .val{ width:76px; text-align:right; opacity:.9; font-variant-numeric: tabular-nums; }
    .hint{ opacity:.7; font-size:12px; margin-top:8px; }
    button{
      cursor:pointer; user-select:none;
      padding:6px 10px; border-radius:10px;
      border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.06);
      color:#eee;
    }
  </style>
</head>
<body>
<canvas id="c"></canvas>

<div class="ui">
  <div class="row">
    <label for="T">time T</label>
    <input id="T" type="range" min="0" max="60" step="0.001" value="8">
    <div class="val" id="TVal"></div>
  </div>

  <div class="row">
    <label for="N">N</label>
    <input id="N" type="range" min="20" max="600" step="1" value="220">
    <div class="val" id="NVal"></div>
  </div>

  <div class="row">
    <label for="S">samples</label>
    <input id="S" type="range" min="300" max="6000" step="1" value="2200">
    <div class="val" id="SVal"></div>
  </div>

  <div class="row">
    <label for="gain">gain</label>
    <input id="gain" type="range" min="20" max="800" step="1" value="220">
    <div class="val" id="GVal"></div>
  </div>

  <div class="row" style="justify-content:space-between;">
    <button id="animate">Play</button>
    <button id="reset">Reset</button>
  </div>

  <div class="hint">
    Если “каша” — уменьшай <b>N</b>.<br/>
    Если “рвано” — увеличивай <b>samples</b>.
  </div>
</div>

<script>
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d', { alpha:false });

  const TInp = document.getElementById('T');
  const NInp = document.getElementById('N');
  const SInp = document.getElementById('S');
  const GInp = document.getElementById('gain');

  const TVal = document.getElementById('TVal');
  const NVal = document.getElementById('NVal');
  const SVal = document.getElementById('SVal');
  const GVal = document.getElementById('GVal');

  const animateBtn = document.getElementById('animate');
  const resetBtn = document.getElementById('reset');

  let W=0, H=0, dpr=1;
  let playing = false;
  let lastTs = 0;

  function resize(){
    dpr = Math.max(1, Math.min(2.5, window.devicePixelRatio || 1));
    W = Math.floor(innerWidth * dpr);
    H = Math.floor(innerHeight * dpr);
    canvas.width = W;
    canvas.height = H;
    draw();
  }
  window.addEventListener('resize', resize);

  // ---- ВАЖНО: тут та самая F(n,T) со скрина (как скалярная "амплитуда") ----
  // Интерпретация записи:
  // F(n,T) = (n^(3/2)/(n+1000)) * ( sin(0.1*n*sin(83.3333*T)) / (0.1*n*T) )
  // В точке T=0 делаем предел (sinc -> 1).
  function F(n, T){
    const a = Math.pow(n, 1.5) / (n + 1000.0);
    const x = 0.1 * n * Math.sin(83.3333 * T);

    // sin(x)/(0.1*n*T) — по записи похоже на "sin(...) / (0.1*n*T)"
    // но при T->0 это 0/0, поэтому стабилизируем:
    const denom = 0.1 * n * T;
    if (Math.abs(denom) < 1e-6) {
      // при T~0: sin(0.1*n*sin(83.3333*T)) ~ 0.1*n*(83.3333*T)
      // а делим на 0.1*n*T => ~83.3333
      // чтобы не улетало, нормируем на 83.3333 (даёт ~1).
      return a * 1.0;
    }
    return a * (Math.sin(x) / denom);
  }

  // Кривая как сумма гармоник:
  // x(s)=Σ F(n,T)*cos(n*s), y(s)=Σ F(n,T)*sin(n*s)
  function curvePoint(s, T, N){
    let x = 0, y = 0;
    for(let n=1; n<=N; n++){
      const w = F(n, T);
      x += w * Math.cos(n * s);
      y += w * Math.sin(n * s);
    }
    return [x, y];
  }

  function draw(){
    const T = parseFloat(TInp.value);
    const N = parseInt(NInp.value, 10);
    const samples = parseInt(SInp.value, 10);
    const gain = parseFloat(GInp.value);

    TVal.textContent = T.toFixed(3);
    NVal.textContent = String(N);
    SVal.textContent = String(samples);
    GVal.textContent = String(gain);

    ctx.fillStyle = '#000';
    ctx.fillRect(0,0,W,H);

    const cx = W/2, cy = H/2;

    ctx.strokeStyle = 'rgba(255,255,255,0.9)';
    ctx.lineWidth = 1.0 * dpr;
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';

    // s идёт по нескольким оборотам, чтобы форма стала богатой
    const turns = 10;                 // можно 6..20
    const sMax = Math.PI * 2 * turns;
    const ds = sMax / (samples - 1);

    ctx.beginPath();
    let s = 0;
    let [x0, y0] = curvePoint(s, T, N);
    ctx.moveTo(cx + x0 * gain * dpr, cy + y0 * gain * dpr);

    for(let i=1; i<samples; i++){
      s = i * ds;
      const [x, y] = curvePoint(s, T, N);
      ctx.lineTo(cx + x * gain * dpr, cy + y * gain * dpr);
    }
    ctx.stroke();
  }

  let raf=0;
  function scheduleDraw(){
    cancelAnimationFrame(raf);
    raf = requestAnimationFrame(draw);
  }

  TInp.addEventListener('input', scheduleDraw);
  NInp.addEventListener('input', scheduleDraw);
  SInp.addEventListener('input', scheduleDraw);
  GInp.addEventListener('input', scheduleDraw);

  animateBtn.addEventListener('click', () => {
    playing = !playing;
    animateBtn.textContent = playing ? 'Pause' : 'Play';
    lastTs = performance.now();
    if (playing) requestAnimationFrame(tick);
  });

  resetBtn.addEventListener('click', () => {
    TInp.value = "0";
    scheduleDraw();
  });

  function tick(ts){
    if (!playing) return;
    const dt = (ts - lastTs) / 1000;
    lastTs = ts;

    // скорость времени
    const speed = 0.6;
    let T = parseFloat(TInp.value);
    T += dt * speed;
    if (T > parseFloat(TInp.max)) T = parseFloat(TInp.min);
    TInp.value = String(T);

    draw();
    requestAnimationFrame(tick);
  }

  resize();
</script>
</body>
</html>
